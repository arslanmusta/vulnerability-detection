package cve.inventoryservice.controller;

import cve.inventoryservice.domain.Inventory;
import cve.inventoryservice.domain.InventoryItem;
import cve.inventoryservice.model.InventoryItemItemModelAssembler;
import cve.inventoryservice.service.InventoryService;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mock;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.hateoas.CollectionModel;
import org.springframework.hateoas.EntityModel;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;

import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyInt;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;

@SpringBootTest
public class InventoryItemControllerTests {
    private InventoryItemController inventoryItemController;

    @Mock
    private InventoryService inventoryService;

    private List<InventoryItem> serviceResult;

    @BeforeEach
    public void setUp() {
        inventoryItemController = new InventoryItemController(inventoryService, new InventoryItemItemModelAssembler());

        serviceResult = new ArrayList<>();
        InventoryItem inventoryItem1 = new InventoryItem();
        inventoryItem1.setId(1);
        inventoryItem1.setVendor("vendor1");
        inventoryItem1.setProduct("product1");
        inventoryItem1.setVersion("version1");

        InventoryItem inventoryItem2 = new InventoryItem();
        inventoryItem2.setId(2);
        inventoryItem2.setVendor("vendor2");
        inventoryItem2.setProduct("product2");
        inventoryItem2.setVersion("version2");
    }

    @Test
    public void whenAllCalled_thenReturnCollectionOfServiceResult() {
        when(inventoryService.findAllItems(1)).thenReturn(serviceResult);

        CollectionModel<EntityModel<InventoryItem>> result = inventoryItemController.all(1);

        assertTrue(result.getContent().stream()
                .allMatch(inventoryItemEntityModel -> serviceResult.stream().anyMatch(i -> i.getId() == inventoryItemEntityModel.getContent().getId())));
    }

    @Test
    public void whenOneCalled_thenReturnModelOfServiceResult() {
        InventoryItem inventoryItem = new InventoryItem();
        inventoryItem.setId(11);
        inventoryItem.setVendor("vendor1");
        inventoryItem.setProduct("product1");
        inventoryItem.setVersion("version1");

        Inventory inventory = new Inventory(new HashSet<>());
        inventory.setId(1);
        inventory.setDomain("domain1");
        inventory.setIp("ip1");
        inventory.addInventoryItem(inventoryItem);

        when(inventoryService.findOneItem(1, 11)).thenReturn(inventoryItem);

        EntityModel<InventoryItem> result = inventoryItemController.one(1, 11);

        assertTrue(result.getContent().getId() == inventoryItem.getId());
    }

    @Test
    public void whenCreateCalled_thenReturnModelOfServiceResult() {
        InventoryItem inventoryItem = new InventoryItem();
        inventoryItem.setId(11);
        inventoryItem.setVendor("vendor1");
        inventoryItem.setProduct("product1");
        inventoryItem.setVersion("version1");

        Inventory inventory = new Inventory(new HashSet<>());
        inventory.setId(1);
        inventory.setDomain("domain1");
        inventory.setIp("ip1");
        inventory.addInventoryItem(inventoryItem);

        when(inventoryService.insertItem(anyInt(), any(InventoryItem.class))).thenReturn(inventoryItem);

        ResponseEntity<EntityModel<InventoryItem>> result = inventoryItemController.createItem(1, inventoryItem);

        verify(inventoryService).insertItem(1, inventoryItem);
        assertTrue(result.getBody().getContent().getId() == inventoryItem.getId());
    }

    @Test
    public void whenUpdateCalled_thenReturnModelOfServiceResult() {
        InventoryItem inventoryItem = new InventoryItem();
        inventoryItem.setId(11);
        inventoryItem.setVendor("vendor1");
        inventoryItem.setProduct("product1");
        inventoryItem.setVersion("version1");

        Inventory inventory = new Inventory(new HashSet<>());
        inventory.setId(1);
        inventory.setDomain("domain1");
        inventory.setIp("ip1");
        inventory.addInventoryItem(inventoryItem);

        when(inventoryService.updateItem(anyInt(), anyInt(), any(InventoryItem.class))).thenReturn(inventoryItem);

        ResponseEntity<EntityModel<InventoryItem>> result = inventoryItemController.updateItem(1, 11, inventoryItem);

        verify(inventoryService).updateItem(1, 11, inventoryItem);
        assertTrue(result.getBody().getContent().getId() == inventoryItem.getId());
    }

    @Test
    public void whenDeleteCalled_thenReturnModelWithNoContent() {
        ResponseEntity<?> result = inventoryItemController.deleteItem(1, 11);

        verify(inventoryService).deleteItem(1, 11);
        assertTrue(result.getStatusCode() == HttpStatus.NO_CONTENT);
    }

}
